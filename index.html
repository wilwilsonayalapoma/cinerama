<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CineramaTv</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Font Awesome para iconos -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <!-- CSS personalizado -->
    <link rel="stylesheet" href="css/style.css" />
  </head>
  <body>
    <!-- SPA HEADER & NAVBAR -->
    <header>
      <div class="container-fluid bg-dark text-white py-2 text-center">
        <div class="row">
          <div class="col-12">
            <div id="spa-carrusel"></div>
          </div>
        </div>
      </div>

      <nav class="navbar navbar-expand-lg navbar-light bg-custom">
        <div class="container">
          <a class="navbar-brand" href="#home" id="spa-home">
            <img
              src="assets/img/sin-fondo.png"
              alt="CineramaTV"
              style="height: 60px; object-fit: contain; cursor: pointer"
              id="navbar-logo"
            />
          </a>
          <button
            class="navbar-toggler"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#navbarNav"
          >
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto">
              <li class="nav-item">
                <a class="nav-link text-white" href="#home">Inicio</a>
              </li>
              <li class="nav-item">
                <a class="nav-link text-white" href="#national">Nacional</a>
              </li>
              <li class="nav-item">
                <a class="nav-link text-white" href="#international"
                  >Internacional</a
                >
              </li>
              <li class="nav-item">
                <a class="nav-link text-white" href="#sports">Deportes</a>
              </li>
              <li class="nav-item">
                <a class="nav-link text-white" href="#culture">Cultura</a>
              </li>
              <li class="nav-item">
                <a class="nav-link text-white" href="#video">Video</a>
              </li>
            </ul>
            <ul class="navbar-nav ms-auto">
              <li class="nav-item">
                <form class="d-flex me-3" role="search" id="navbarSearchForm">
                  <input
                    class="form-control"
                    type="search"
                    placeholder="Buscar..."
                    aria-label="Buscar"
                    id="navbarSearchInput"
                    style="width: 160px"
                  />
                  <button
                    class="btn btn-outline-light ms-2"
                    type="submit"
                    id="navbarSearchBtn"
                  >
                    <i class="fa fa-search"></i>
                  </button>
                </form>
              </li>
              <li class="nav-item" id="user-session-nav">
                <!-- Aquí se renderiza dinámicamente el botón de login o cerrar sesión -->
              </li>
            </ul>
          </div>
        </div>
      </nav>
    </header>

    <!-- SPA MAIN CONTAINER -->
    <main class="container py-5">
      <div id="spa-view"></div>
    </main>

    <!-- Modal de inicio de sesión -->
    <div
      class="modal fade"
      id="loginModal"
      tabindex="-1"
      aria-labelledby="loginModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div
          class="modal-content"
          style="
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 4px 24px rgba(41, 62, 90, 0.15);
          "
        >
          <div class="modal-header" style="border-bottom: 1px solid #e3e3e3">
            <h5
              class="modal-title"
              id="loginModalLabel"
              style="color: #293e5a; font-weight: bold"
            >
              Iniciar sesión
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Cerrar"
            ></button>
          </div>
          <div class="modal-body">
            <form id="loginForm">
              <div class="mb-3">
                <label for="loginEmail" class="form-label"
                  >Correo electrónico</label
                >
                <input
                  type="email"
                  class="form-control"
                  id="loginEmail"
                  placeholder="correo@ejemplo.com"
                  required
                />
                <div class="invalid-feedback">Ingresa un correo válido.</div>
              </div>
              <div class="mb-3">
                <label for="loginPassword" class="form-label">Contraseña</label>
                <input
                  type="password"
                  class="form-control"
                  id="loginPassword"
                  placeholder="Contraseña"
                  required
                />
                <div class="invalid-feedback">Ingresa tu contraseña.</div>
              </div>
              <button type="submit" class="btn btn-primary w-100">
                Ingresar
              </button>
            </form>
            <div class="text-center mt-3">
              <span>¿No tienes cuenta?</span>
              <a
                href="#"
                class="text-primary"
                data-bs-toggle="modal"
                data-bs-target="#registerModal"
                data-bs-dismiss="modal"
                >Registrarse</a
              >
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal de registro de usuario -->
    <div
      class="modal fade"
      id="registerModal"
      tabindex="-1"
      aria-labelledby="registerModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div
          class="modal-content"
          style="
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 4px 24px rgba(41, 62, 90, 0.15);
          "
        >
          <div class="modal-header" style="border-bottom: 1px solid #e3e3e3">
            <h5
              class="modal-title"
              id="registerModalLabel"
              style="color: #293e5a; font-weight: bold"
            >
              Registrarse
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Cerrar"
            ></button>
          </div>
          <div class="modal-body">
            <form id="registerForm">
              <div class="mb-3">
                <label for="registerName" class="form-label"
                  >Nombre completo</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="registerName"
                  placeholder="Tu nombre completo"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="registerEmail" class="form-label"
                  >Correo electrónico</label
                >
                <input
                  type="email"
                  class="form-control"
                  id="registerEmail"
                  placeholder="correo@ejemplo.com"
                  required
                />
                <div class="invalid-feedback">Ingresa un correo válido.</div>
              </div>
              <div class="mb-3">
                <label for="registerPassword" class="form-label"
                  >Contraseña</label
                >
                <input
                  type="password"
                  class="form-control"
                  id="registerPassword"
                  placeholder="Contraseña"
                  required
                  minlength="6"
                />
              </div>
              <div class="mb-3">
                <label for="registerPassword2" class="form-label"
                  >Repetir contraseña</label
                >
                <input
                  type="password"
                  class="form-control"
                  id="registerPassword2"
                  placeholder="Repite la contraseña"
                  required
                  minlength="6"
                />
                <div class="invalid-feedback">
                  Las contraseñas no coinciden.
                </div>
              </div>
              <button type="submit" class="btn btn-primary w-100">
                Registrarse
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer (sería un include en PHP) -->
    <footer class="footer-custom text-white py-4 mt-5">
      <div class="container">
        <div class="row">
          <div class="col-md-4">
            <h5>Cinerama Tv</h5>
            <p>Tu fuente confiable de noticias actualizadas las 24 horas.</p>
          </div>
          <div class="col-md-4">
            <h5>Enlaces útiles</h5>
            <ul class="list-unstyled">
              <li><a href="#" class="text-white">Sobre nosotros</a></li>
              <li><a href="#" class="text-white">Contacto</a></li>
              <li><a href="#" class="text-white">Política de privacidad</a></li>
            </ul>
          </div>
          <div class="col-md-4">
            <h5>Síguenos</h5>
            <div class="d-flex gap-3">
              <a href="#" class="text-white"
                ><i class="fab fa-facebook fa-2x"></i
              ></a>
              <a href="#" class="text-white"
                ><i class="fab fa-twitter fa-2x"></i
              ></a>
              <a href="#" class="text-white"
                ><i class="fab fa-instagram fa-2x"></i
              ></a>
            </div>
          </div>
        </div>
        <hr />
        <p class="text-center mb-0">
          &copy; 2023 Cinerama. Todos los derechos reservados.
        </p>
      </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // Renderiza el botón de sesión (login/cerrar sesión) en el navbar
      function renderUserSessionNav() {
        const nav = document.getElementById("user-session-nav");
        let usuario = null;
        try {
          usuario = JSON.parse(localStorage.getItem("usuario"));
        } catch (e) {}
        if (usuario) {
          nav.innerHTML = `<button class="btn btn-outline-light ms-2" id="cerrarSesionBtn" title="Cerrar sesión"><i class="fas fa-sign-out-alt"></i> Cerrar sesión</button>`;
        } else {
          nav.innerHTML = `<button class="btn btn-link ms-2 p-0" type="button" data-bs-toggle="modal" data-bs-target="#loginModal" title="Iniciar sesión o registrarse"><i class="fa fa-user-circle fa-2x" style="color: #fff"></i></button>`;
        }
      }

      // Evento para cerrar sesión
      document.addEventListener("click", function (e) {
        if (
          e.target &&
          (e.target.id === "cerrarSesionBtn" ||
            e.target.closest("#cerrarSesionBtn"))
        ) {
          cerrarSesion();
        }
      });

      // Llamar al renderizado de sesión al cargar
      document.addEventListener("DOMContentLoaded", function () {
        renderUserSessionNav();
      });

      // Llamar también después de login/logout
      window.renderUserSessionNav = renderUserSessionNav;

      // Renderiza el carrusel dinámico desde la base de datos
      function renderCarrusel() {
        $.getJSON("api/publicidad.php", function (data) {
          if (!data || !data.length) {
            $("#spa-carrusel").html("");
            return;
          }
          var html =
            '<div id="cineramaCarrusel" class="carousel slide" data-bs-ride="carousel" data-bs-interval="4000">';
          html += '<div class="carousel-inner">';
          data.forEach(function (item, idx) {
            html += `<div class="carousel-item${idx === 0 ? " active" : ""}">`;
            html += `<img src="${item.imagen}" class="d-block w-100" alt="Publicidad" style="max-height:180px;object-fit:cover;border-radius:10px;box-shadow:0 2px 8px 0 rgba(41,62,90,0.10),0 0 0 2px rgba(41,62,90,0.10);">`;
            if (item.link) {
              html += `<a href="${item.link}" target="_blank" class="stretched-link"></a>`;
            }
            html += `</div>`;
          });
          html += "</div>";
          html +=
            '<button class="carousel-control-prev" type="button" data-bs-target="#cineramaCarrusel" data-bs-slide="prev">';
          html +=
            '<span class="carousel-control-prev-icon" aria-hidden="true"></span>';
          html += '<span class="visually-hidden">Anterior</span></button>';
          html +=
            '<button class="carousel-control-next" type="button" data-bs-target="#cineramaCarrusel" data-bs-slide="next">';
          html +=
            '<span class="carousel-control-next-icon" aria-hidden="true"></span>';
          html += '<span class="visually-hidden">Siguiente</span></button>';
          html += "</div>";
          $("#spa-carrusel").html(html);
          // Forzar el intervalo si Bootstrap 5 no lo toma del atributo
          var carrusel = document.getElementById("cineramaCarrusel");
          if (carrusel && typeof bootstrap !== "undefined") {
            var carouselInstance = bootstrap.Carousel.getOrCreateInstance(
              carrusel,
              { interval: 4000, ride: "carousel" }
            );
          }
        });
      }

      // SPA Router y Render
      function renderView(route) {
        const view = document.getElementById("spa-view");
        if (route === "#home" || route === "" || route === "#") {
          view.innerHTML =
            '<div class="text-center"><div class="spinner-border"></div><p>Cargando página principal...</p></div>';
          $.getJSON("api/home.php", function (data) {
            var html = `<section class="news-section"><div class="row">`;
            html += `<div class="col-md-8">`;
            // Video principal
            html += `<div class="video-container mb-4"><iframe src="${data.video.src}" allowfullscreen></iframe></div>`;
            html += `<div class="mb-4"><h2 class="mb-3">${data.video.titulo}</h2><p class="lead">${data.video.descripcion}</p><div class="d-flex justify-content-between align-items-center"><div><span class="text-muted">Publicado el ${data.video.fecha}</span>`;
            if (data.video.en_vivo)
              html += '<span class="badge bg-danger ms-2">En vivo</span>';
            html += `</div><div><button class="btn btn-outline-primary btn-sm me-2"><i class="fas fa-share-alt"></i> Compartir</button><button class="btn btn-outline-secondary btn-sm"><i class="fas fa-bookmark"></i> Guardar</button></div></div></div>`;
            html += `<h2 class="section-title my-4">Últimas Noticias</h2><div class="row">`;
            data.ultimas.forEach(function (noticia) {
              var img = noticia.imagen
                ? noticia.imagen
                : "https://via.placeholder.com/400x250?text=Sin+Imagen";
              var categoria = noticia.categoria || "Sin categoría";
              var cat_color = noticia.categoria_color || "secondary";
              html += `<div class="col-md-6 mb-4"><div class="card article-card"><img src="${img}" class="card-img-top" alt="Noticia" style="height:220px;object-fit:cover;"><div class="card-body"><span class="badge" style="background:${cat_color};color:#fff;">${categoria}</span><h5 class="card-title">${
                noticia.titulo
              }</h5><p class="card-text">${
                noticia.resumen || ""
              }</p><div class="d-flex justify-content-between align-items-center">
                <button class="btn btn-primary btn-sm leer-mas-btn" data-id="${
                  noticia.id
                }">Leer más</button>
                <div>
                  <span class="badge bg-warning text-dark me-1"><i class="fas fa-star"></i> ${
                    noticia.destacados || 0
                  }</span>
                  <span class="badge bg-secondary"><i class="fas fa-comments"></i> ${
                    noticia.comentarios || 0
                  }</span>
                </div>
                <small class="text-muted ms-2">${noticia.fecha}</small>
              </div></div></div></div>`;
            });
            html += `</div></div>`;
            // Columna lateral
            html += `<div class="col-md-4">`;
            // Destacadas del día
            html += `<div class="bg-light p-3 rounded mb-4"><h4>Destacadas del día</h4><div class="list-group">`;
            if ((data.destacadas_dia || []).length === 0) {
              html += `<div class='text-muted p-3'>No hay noticias destacadas hoy.</div>`;
            } else {
              data.destacadas_dia.slice(0, 3).forEach(function (dest) {
                html += `<a href="#noticia-${
                  dest.id
                }" class="list-group-item list-group-item-action">
                  <div class="d-flex align-items-center">
                    <img src="${
                      dest.imagen || "assets/img/fondo1-1.webp"
                    }" alt="miniatura" class="me-2 rounded" style="width:48px;height:48px;object-fit:cover;">
                    <div>
                      <h6 class="mb-1">${dest.titulo}</h6>
                      <span class="badge ms-1" style="background:${
                        dest.categoria_color
                      };color:#fff;">${
                  dest.destacados
                } <i class='fas fa-star'></i></span>
                    </div>
                  </div>
                  <p class="mb-1">${dest.resumen || ""}</p>
                  <small class="text-muted">${dest.fecha}</small>
                </a>`;
              });
            }
            html += `</div></div>`;
            // Más comentadas
            html += `<div class="bg-light p-3 rounded mb-4"><h4>Más comentadas</h4><div class="list-group">`;
            (data.mas_comentadas || []).slice(0, 3).forEach(function (noticia) {
              html += `<a href="#noticia-${
                noticia.id
              }" class="list-group-item list-group-item-action">
                <div class="d-flex align-items-center">
                  <img src="${
                    noticia.imagen || "assets/img/fondo1-1.webp"
                  }" alt="miniatura" class="me-2 rounded" style="width:48px;height:48px;object-fit:cover;">
                  <div>
                    <h6 class="mb-1">${noticia.titulo}</h6>
                    <span class="badge ms-1 bg-secondary">${
                      noticia.comentarios
                    } <i class='fas fa-comments'></i></span>
                  </div>
                </div>
                <p class="mb-1">${noticia.resumen || ""}</p>
                <small class="text-muted">${noticia.fecha}</small>
              </a>`;
            });
            html += `</div></div>`;
            // Clasificación Deportiva
            html += `<div class="bg-light p-3 rounded mb-4"><h4>Clasificación Deportiva</h4><ul class="list-group">`;
            (data.clasificacion || []).forEach(function (eq, i) {
              var bg = i % 2 === 0 ? "bg-white" : "bg-light";
              html += `<li class="list-group-item d-flex justify-content-between align-items-center ${bg}">${eq.equipo}<span class="badge bg-primary rounded-pill">${eq.puntos} pts</span></li>`;
            });
            html += `</ul></div>`;
            // Boletín
            html += `<div class="bg-light p-3 rounded"><h4>Boletín informativo</h4><p>Suscríbete para recibir las últimas noticias</p><form id="newsletterForm"><div class="mb-3"><input type="email" class="form-control" placeholder="Tu email" required></div><button type="submit" class="btn btn-primary w-100">Suscribirse</button></form></div>`;
            html += `</div></div></section>`;
            view.innerHTML = html;
            // SPA: Navegación al detalle
            $(".leer-mas-btn").click(function () {
              var id = $(this).data("id");
              window.location.hash = "#noticia-" + id;
            });
            // Newsletter form
            $("#newsletterForm").submit(function (e) {
              e.preventDefault();
              alert("¡Gracias por suscribirte!");
            });
          });
        } else if (
          route === "#national" ||
          route === "#international" ||
          route === "#culture" ||
          route === "#sports"
        ) {
          let section = "Nacional";
          let api = "api/national.php";
          if (route === "#international") {
            section = "Internacional";
            api = "api/international.php";
          }
          if (route === "#culture") {
            section = "Cultura";
            api = "api/culture.php";
          }
          if (route === "#sports") {
            section = "Deportes";
            api = "api/sports.php";
          }
          view.innerHTML = `<h2 class="mb-4">Noticias ${section}</h2><div id="national-list" class="row"></div>`;
          $.getJSON(api, function (data) {
            var html = "";
            if (data.length > 0) {
              html += `<div class="col-lg-8">
                <div class="row">`;
              // Primera noticia en grande
              var noticia = data[0];
              html += `<div class="col-12 mb-4">
                <div class="card article-card shadow-lg">
                  <img src="${
                    noticia.imagen
                  }" class="card-img-top" alt="Noticia" style="height:340px;object-fit:cover;">
                  <div class="card-body">
                    <span class="badge" style="background:${
                      noticia.categoria_color
                    };color:#fff;">${noticia.categoria}</span>
                    <h2 class="card-title mt-2 mb-3">${noticia.titulo}</h2>
                    <p class="card-text" style="font-size:1.2em;">${
                      noticia.resumen || ""
                    }</p>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                      <span><i class="fas fa-star text-warning"></i> <span class="destacados-count" data-id="${
                        noticia.id
                      }">${noticia.destacados}</span> Destacados</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                      <button class="btn btn-primary btn-sm leer-mas-btn" data-id="${
                        noticia.id
                      }">Leer más</button>
                      ${(() => {
                        let usuario = null;
                        try {
                          usuario = JSON.parse(localStorage.getItem("usuario"));
                        } catch (e) {}
                        if (usuario && usuario.id) {
                          return `<button class="btn btn-warning btn-sm destacar-btn" data-id="${noticia.id}"><i class="fas fa-star"></i> Destacar</button>`;
                        } else {
                          return "";
                        }
                      })()}
                      <small class="text-muted">${noticia.fecha}</small>
                    </div>
                  </div>
                </div>
              </div>`;
              // Siguientes 4 noticias en formato regular
              for (var i = 1; i < Math.min(data.length, 5); i++) {
                var noticia = data[i];
                html += `<div class="col-md-6 mb-4">
                  <div class="card article-card">
                    <img src="${
                      noticia.imagen
                    }" class="card-img-top" alt="Noticia" style="height:220px;object-fit:cover;">
                    <div class="card-body">
                      <span class="badge" style="background:${
                        noticia.categoria_color
                      };color:#fff;">${noticia.categoria}</span>
                      <h5 class="card-title">${noticia.titulo}</h5>
                      <p class="card-text">${noticia.resumen || ""}</p>
                      <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="badge bg-warning text-dark me-1"><i class="fas fa-star"></i> ${
                          noticia.destacados || 0
                        }</span>
                        <span class="badge bg-secondary"><i class="fas fa-comments"></i> ${
                          noticia.comentarios || 0
                        }</span>
                      </div>
                      <div class="d-flex justify-content-between align-items-center">
                        <button class="btn btn-primary btn-sm leer-mas-btn" data-id="${
                          noticia.id
                        }">Leer más</button>
                        ${(() => {
                          let usuario = null;
                          try {
                            usuario = JSON.parse(
                              localStorage.getItem("usuario")
                            );
                          } catch (e) {}
                          if (usuario && usuario.id) {
                            return `<button class="btn btn-warning btn-sm destacar-btn" data-id="${noticia.id}"><i class="fas fa-star"></i> Destacar</button>`;
                          } else {
                            return "";
                          }
                        })()}
                        <small class="text-muted">${noticia.fecha}</small>
                      </div>
                    </div>
                  </div>
                </div>`;
              }
              html += `</div></div>`;
              // Noticias destacadas reales (las 2 con más destacados)
              var destacadas = [...data]
                .sort((a, b) => b.destacados - a.destacados)
                .slice(0, 4);
              html += `<div class="col-lg-4">
                <div class="bg-light p-3 rounded mb-4 border border-2" style="border-color:${noticia.categoria_color};">
                  <h4 class="mb-3" style="color:${noticia.categoria_color};font-weight:bold;">Noticias Destacadas</h4>`;
              destacadas.forEach(function (dest, idx) {
                html += `<a href="#noticia-${
                  dest.id
                }" class="list-group-item list-group-item-action mb-2 rounded shadow-sm">
                  <div class="d-flex w-100 align-items-center justify-content-between">
                    <img src="${
                      dest.imagen || "assets/img/fondo1-1.webp"
                    }" alt="miniatura" class="me-2 rounded" style="width:48px;height:48px;object-fit:cover;">
                    <div class="flex-grow-1">
                      <h6 class="mb-1">${
                        idx === 0
                          ? '<span class="text-danger fw-bold">&#9733; </span>'
                          : ""
                      }${dest.titulo}</h6>
                      <span class="badge ms-1" style="background:${
                        dest.categoria_color
                      };color:#fff;">${
                  dest.destacados
                } <i class='fas fa-star'></i></span>
                    </div>
                  </div>
                  <p class="mb-1">${dest.resumen || ""}</p>
                  <small class="text-muted">${dest.fecha}</small>
                </a>`;
              });
              html += `</div>
                <div class="bg-light p-3 rounded mt-4 border border-2" style="border-color:${noticia.categoria_color};">
                  <h4 class="mb-3" style="color:${noticia.categoria_color};font-weight:bold;">Boletín informativo</h4>
                  <p>Suscríbete para recibir las últimas noticias</p>
                  <form id="newsletterForm"><div class="mb-3"><input type="email" class="form-control" placeholder="Tu email" required></div><button type="submit" class="btn btn-primary w-100">Suscribirse</button></form>
                </div>
              </div>`;
            }
            document.getElementById("national-list").innerHTML = html;
            // SPA: Navegación al detalle
            $(".leer-mas-btn").click(function () {
              var id = $(this).data("id");
              window.location.hash = "#noticia-" + id;
            });
            // SPA: Destacar noticia
            $(".destacar-btn")
              .off("click")
              .on("click", function () {
                var noticiaId = $(this).data("id");
                var usuario = null;
                try {
                  usuario = JSON.parse(localStorage.getItem("usuario"));
                } catch (e) {}
                if (!usuario || !usuario.id) {
                  alert("Debes iniciar sesión para destacar.");
                  return;
                }
                var usuarioId = usuario.id;
                var $btn = $(this);
                $btn.prop("disabled", true);
                $.post(
                  "api/destacar.php",
                  { noticia_id: noticiaId, usuario_id: usuarioId },
                  function (resp) {
                    var data = {};
                    try {
                      data = JSON.parse(resp);
                    } catch (e) {}
                    if (data.success) {
                      // Actualizar todos los contadores y botones de la noticia en la página
                      $(".destacados-count[data-id='" + noticiaId + "']").each(
                        function () {
                          $(this).text(parseInt($(this).text()) + 1);
                        }
                      );
                      $(".destacar-btn[data-id='" + noticiaId + "']").each(
                        function () {
                          $(this).prop("disabled", true).text("Destacado");
                        }
                      );
                    } else {
                      alert(data.msg || "Ya has destacado esta noticia.");
                      $(".destacar-btn[data-id='" + noticiaId + "']").each(
                        function () {
                          $(this).prop("disabled", true).text("Destacado");
                        }
                      );
                    }
                  }
                );
              });
          });
        } else if (route === "#publicidad") {
          view.innerHTML =
            '<h2>Publicidad</h2><div id="publicidad-list" class="row"></div>';
          $.getJSON("api/publicidad.php", function (data) {
            var html = "";
            data.forEach(function (img) {
              html += `<div class=\"col-md-4 mb-4\"><div class=\"card\"><img src=\"${img.imagen}\" class=\"card-img-top\" alt=\"${img.nombre}\" style=\"height:180px;object-fit:cover;\"><div class=\"card-body\"><h5 class=\"card-title\">${img.nombre}</h5>`;
              if (img.link)
                html += `<a href=\"${img.link}\" target=\"_blank\" class=\"btn btn-primary btn-sm\">Ir al sitio</a>`;
              html += "</div></div></div>";
            });
            document.getElementById("publicidad-list").innerHTML = html;
          });
        } else if (route.startsWith("#noticia-")) {
          var usuario = null;
          try {
            usuario = JSON.parse(localStorage.getItem("usuario"));
          } catch (e) {}
          var noticiaId = route.replace("#noticia-", "");
          view.innerHTML =
            '<div class="text-center"><div class="spinner-border"></div><p>Cargando noticia...</p></div>';
          $.getJSON("api/noticia.php?id=" + noticiaId, function (data) {
            if (data.error) {
              view.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
              return;
            }
            var html = `<div class=\"card mb-4\">
            <img src=\"${
              data.imagen
            }\" class=\"card-img-top\" alt=\"Imagen noticia\" style=\"max-height:350px;object-fit:cover;\">
            <div class=\"card-body\">
              <span class=\"badge\" style=\"background:${
                data.categoria_color
              };color:#fff;\">${data.categoria}</span>
              <h2 class=\"card-title mt-2 mb-3\">${data.titulo}</h2>
              <p class=\"card-text\" style=\"font-size:1.2em;\">${
                data.contenido
              }</p>
              <div class=\"mt-3 mb-3 d-flex gap-2\">
                <span class=\"text-muted\">Publicado el ${new Date(
                  data.fecha
                ).toLocaleDateString()}</span>
                <span class=\"ms-3\">Por: ${data.autor}</span>
              </div>
              <div class=\"mb-4\">
                <span><i class=\"fas fa-star text-warning\"></i> <span id=\"destacados-count\">${
                  data.destacados
                }</span> Destacados</span>
                ${
                  usuario
                    ? '<button class="btn btn-warning btn-sm ms-2" id="destacar-btn"><i class="fas fa-star"></i> Destacar</button>'
                    : '<button class="btn btn-warning btn-sm ms-2" id="destacar-btn" disabled title="Inicia sesión para destacar"><i class="fas fa-star"></i> Destacar</button>'
                }
                <button class=\"btn btn-info btn-sm ms-2\" id=\"compartir-btn\"><i class=\"fas fa-share\"></i> Compartir</button>
              </div>
              <button class=\"btn btn-secondary mt-4\" onclick=\"window.location.hash='#national'\">Volver a Nacional</button>
            </div>
          </div>`;
            html += `<div class=\"card mb-4\"><div class=\"card-header bg-light\"><h5 class=\"mb-0\"><i class=\"fas fa-comments\"></i> Comentarios</h5></div><div class=\"card-body\">`;
            if (usuario) {
              html += `<form id=\"formComentario\" class=\"d-flex mb-3\"><input type=\"text\" class=\"form-control me-2\" name=\"comentario\" placeholder=\"Escribe un comentario...\" maxlength=\"255\" required><button type=\"submit\" class=\"btn btn-success\">Comentar</button></form>`;
            } else {
              html += `<div class=\"alert alert-warning\">Inicia sesión para comentar.</div>`;
            }
            html += '<div id="comentariosList">';
            if (data.comentarios.length === 0) {
              html += '<p class="text-muted">No hay comentarios aún.</p>';
            } else {
              data.comentarios.forEach(function (c) {
                html += `<div class=\"mb-2 border-bottom pb-2\"><strong>${
                  c.autor
                }</strong> <span class=\"text-muted ms-2\" style=\"font-size:0.9em;\">${new Date(
                  c.fecha
                ).toLocaleDateString()}</span><p class=\"mb-1 mt-1\">${
                  c.comentario
                }</p></div>`;
              });
            }
            html += "</div></div>";
            view.innerHTML = html;
            // Compartir funcionalidad
            $("#compartir-btn").on("click", function () {
              var url =
                window.location.origin +
                window.location.pathname +
                "#noticia-" +
                noticiaId;
              navigator.clipboard.writeText(url).then(function () {
                $("#compartir-btn").text("¡Enlace copiado!");
                setTimeout(function () {
                  $("#compartir-btn").html(
                    '<i class="fas fa-share"></i> Compartir'
                  );
                }, 1500);
              });
            });
            // Interactividad destacar
            if (usuario) {
              $("#destacar-btn").click(function () {
                var usuarioId = usuario.id;
                $.post(
                  "api/destacar.php",
                  { noticia_id: noticiaId, usuario_id: usuarioId },
                  function (resp) {
                    var data = {};
                    try {
                      data = JSON.parse(resp);
                    } catch (e) {}
                    if (data.success) {
                      var count = parseInt($("#destacados-count").text()) + 1;
                      $("#destacados-count").text(count);
                      $("#destacar-btn")
                        .prop("disabled", true)
                        .text("Destacado");
                    } else {
                      alert(data.msg || "Error al destacar.");
                    }
                  }
                );
              });
            }
            // Interactividad comentar
            if (usuario) {
              $("#formComentario").submit(function (e) {
                e.preventDefault();
                var usuarioId = usuario.id;
                var $input = $(this).find('input[name="comentario"]');
                var comentario = $input.val();
                var $comentariosList = $("#comentariosList");
                $.post(
                  "api/comentar.php",
                  {
                    noticia_id: noticiaId,
                    usuario_id: usuarioId,
                    comentario: comentario,
                  },
                  function (resp) {
                    var data = {};
                    try {
                      data = JSON.parse(resp);
                    } catch (e) {}
                    if (data.success) {
                      // Agregar el comentario al listado dinámicamente
                      var fecha = new Date();
                      var autor = usuario.nombre || "Tú";
                      var nuevoComentario = `<div class=\"mb-2 border-bottom pb-2\"><strong>${autor}</strong> <span class=\"text-muted ms-2\" style=\"font-size:0.9em;\">${fecha.toLocaleDateString()}</span><p class=\"mb-1 mt-1\">${escapeHTML(
                        comentario
                      )}</p></div>`;
                      // Si era el primer comentario, quitar el mensaje de vacío
                      if ($comentariosList.find(".text-muted").length) {
                        $comentariosList.html("");
                      }
                      $comentariosList.prepend(nuevoComentario);
                      $input.val("");
                      $input.focus();
                    } else {
                      alert(data.msg || "Error al comentar.");
                    }
                  }
                );
              });
            }
          });
        } else {
          view.innerHTML = `<h2>Sección en construcción</h2><p>Pronto disponible: ${route.replace(
            "#",
            ""
          )}</p>`;
        }
      }

      function spaRouter() {
        renderView(window.location.hash);
        renderUserSessionNav();
      }
      window.addEventListener("hashchange", spaRouter);
      window.addEventListener("DOMContentLoaded", function () {
        spaRouter();
        renderCarrusel();
        renderUserSessionNav();
      });
    </script>
    <script src="js/script.js"></script>
    <div
      id="toast-container"
      class="position-fixed top-0 end-0 p-3"
      style="z-index: 1060"
    ></div>
  </body>
</html>
